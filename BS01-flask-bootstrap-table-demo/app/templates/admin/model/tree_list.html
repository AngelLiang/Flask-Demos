{% extends 'admin/model/list.html' %}


{% block head %}
    {{ super() }}
    <link href="{{ url_for('static', filename='bootstrap-table-1.15.5/css/bootstrap-table.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/jquery.treegrid.css') }}" rel="stylesheet">
{% endblock %}

{% block body %}
    <div class="table-responsive">
        {% block model_menu_bar %}
        <ul class="nav nav-tabs actions-nav">
            {# List #}
            <li class="active">
                <a href="javascript:void(0)">{{ _gettext('List') }}{% if count %} ({{ count }}){% endif %}</a>
            </li>

            {# 可创建 #}
            {% if admin_view.can_create %}
            <li>
            {%- if admin_view.create_modal -%}
                {# 模态框 #}
                {{ lib.add_modal_button(url=get_url('.create_view', url=return_url, modal=True), title=_gettext('Create New Record'), content=_gettext('Create')) }}
            {% else %}
                <a href="{{ get_url('.create_view', url=return_url) }}" title="{{ _gettext('Create New Record') }}">{{ _gettext('Create') }}</a>
            {%- endif -%}
            </li>
            {% endif %}

            {# 可导出 #}
            {% if admin_view.can_export %}
                {{ model_layout.export_options() }}
            {% endif %}

            {# 在 filter 前添加 menu bar #}
            {% block model_menu_bar_before_filters %}{% endblock %}

            {# 可过滤 #}
            {% if filters %}
            <li class="dropdown">
                {{ model_layout.filter_options() }}
            </li>
            {% endif %}

            {# 可设置页面大小 #}
            {% if can_set_page_size %}
            <li class="dropdown">
                {{ model_layout.page_size_form(page_size_url) }}
            </li>
            {% endif %}

            {# 下弹窗，默认有批量删除选项 #}
            {% if actions %}
            <li class="dropdown">
                {{ actionlib.dropdown(actions) }}
            </li>
            {% endif %}

            {# 搜索表单 #}
            {% if search_supported %}
            <li>
                {{ model_layout.search_form() }}
            </li>
            {% endif %}
            {# 在 filter 后添加 menu bar #}
            {% block model_menu_bar_after_filters %}{% endblock %}
        </ul>
        {% endblock %}

        {# 过滤表单 #}
        {% if filters %}
            {{ model_layout.filter_form() }}
            <div class="clearfix"></div>
        {% endif %}

        <table id="table"></table>
    <div>

    {# 分页 #}
    {% block list_pager %}
    {% if num_pages is not none %}
    {{ lib.pager(page, num_pages, pager_url) }}
    {% else %}
    {{ lib.simple_pager(page, data|length == page_size, pager_url) }}
    {% endif %}
    {% endblock %}

    {# action form #}
    {% block actions %}
    {{ actionlib.form(actions, get_url('.action_view')) }}
    {% endblock %}

    {%- if admin_view.edit_modal or admin_view.create_modal or admin_view.details_modal -%}
        {{ lib.add_modal_window() }}
    {%- endif -%}

{% endblock %}

{% block tail_js %}
    <script src="{{ admin_static.url(filename='vendor/jquery.min.js', v='2.1.4') }}" type="text/javascript"></script>
    {# <script src="{{ url_for('static', filename='js/jquery-3.4.1.js') }}" type="text/javascript"></script> #}

    <script src="{{ admin_static.url(filename='bootstrap/bootstrap3/js/bootstrap.min.js', v='3.3.5') }}" type="text/javascript"></script>
    {# <script src="{{ url_for('static', filename='bootstrap-3.3.7/js/bootstrap.min.js') }}" type="text/javascript"></script> #}

    <script src="{{ admin_static.url(filename='vendor/moment.min.js', v='2.9.0') }}" type="text/javascript"></script>
    <script src="{{ admin_static.url(filename='vendor/select2/select2.min.js', v='3.5.2') }}" type="text/javascript"></script>

    {% if admin_view.extra_js %}
      {% for js_url in admin_view.extra_js %}
        <script src="{{ js_url }}" type="text/javascript"></script>
      {% endfor %}
    {% endif %}


    <script src="{{ url_for('static', filename='js/jquery-cookie-1.4.1.js') }}" type="text/javascript"></script>

    {# <script src="{{ url_for('static', filename='js/jquery-treegrid-bootstrap3.js') }}" type="text/javascript"></script> #}
    <script src="{{ url_for('static', filename='bootstrap-table-1.15.5/js/bootstrap-table.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='bootstrap-table-1.15.5/locale/bootstrap-table-zh-CN.min.js') }}" type="text/javascript"></script>

    <script src="{{ url_for('static', filename='js/jquery-treegrid-0.3.0.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='bootstrap-table-1.15.5/extensions/treegrid/js/bootstrap-table-treegrid.js') }}" type="text/javascript"></script>

    <script>
      $(function() {

        var columns = JSON.parse('{{ get_column_json()|tojson|safe }}')
        var data_json = JSON.parse('{{ get_data_json()|tojson|safe }}')

        
        function optionationsFormatter(value, row, index) {

            {# return JSON.parse('{{ render_list_row_actions(data[0])|tojson|safe }}') #}
            {# return {{ render_list_row_actions(index) }} #}

            var details_view = '<a class="icon" href="{{ url_for('.details_view') }}?id='+ row.id +'" title="查看记录"><span class="fa fa-eye glyphicon glyphicon-eye-open"></span></a>'
            var edit_view = '<a class="icon" href="{{ url_for('.edit_view') }}?id='+ row.id +'" title="编辑记录"><span class="fa fa-eye glyphicon glyphicon-edit"></span></a>'
            var delete_btn = '<a class="icon" href="{{ url_for('.delete_view') }}?id='+ row.id +'" title="删除记录"><span class="fa fa-eye glyphicon glyphicon-trash"></span></a>'
            return [
                {%- if admin_view.can_view_details -%}
                    details_view,
                {%- endif -%}
                {%- if admin_view.can_edit -%}
                    edit_view,
                {%- endif -%}
                {%- if admin_view.can_delete -%}
                    delete_btn,
                {%- endif -%}
            ].join(' ')
        };

        {% if actions %}
            columns[0]['title'] = '<input type="checkbox" name="rowtoggle" class="action-rowtoggle" title="{{ _gettext('Select all records') }}" />';
            columns[0]['formatter'] = function checkboxFormatter(value, row, index) {
                return '<input type="checkbox" name="rowid" class="action-checkbox" value="' + row.id + '" title="{{ _gettext('Select record') }}" />'
            };
            columns[1]['formatter'] = optionationsFormatter
            var treeColumn = 1
        {% else %}
            columns[0]['formatter'] = optionationsFormatter
            var treeColumn = 0
        {% endif %}

        var $table = $('#table');
        $table.bootstrapTable({
          locale: 'zh-CN',
          //classes: 
          // 当数据为undefined时显示的字符，默认是'-'。
          undefinedText : '',
          columns: columns,

          data: data_json,

          // showRefresh: true,
          // showColumns: true,
          // toolbar: '#toolbar',
          pagination: false,
          sidePagination: 'server',
          pageSize: 10,
          pageNumber: 1,
          pageList: [10, 25, 50],

          idField: 'id',
          treeShowField: 'id',
          parentIdField: 'parent_id',
          // rootParentId: null,
          onResetView: function(data) {
            $table.treegrid({
                /*
                Initial state of tree
                'expanded' - all nodes will be expanded
                'collapsed' - all nodes will be collapsed
                */
                initialState: 'collapsed',

                // If true you can reload page and tree state was saved
                // need jquery-cookie.js
                saveState: true, 

                treeColumn: treeColumn,
                expanderExpandedClass: 'glyphicon glyphicon-minus', // 图标样式
                expanderCollapsedClass: 'glyphicon glyphicon-plus',
                onChange: function() {
                    //console.log('onChange')
                    $table.bootstrapTable('resetWidth');
                },
                onCollapse: function() {
                    //console.log("Collapsed: "+$(this).attr("id"))
                }, 
                onExpand: function() {
                    //console.log("Expanded "+$(this).attr("id"))
                }
            })
          }
        })

      })
  </script>
{% endblock %}

{% block tail %}
    {{ super() }}
{% endblock %}
